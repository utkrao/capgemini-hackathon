/*
THIS INFRAGISTICS ULTIMATE SOFTWARE LICENSE  AGREEMENT ("AGREEMENT") LOCATED HERE:
https://www.infragistics.com/legal/license/igultimate-la
https://www.infragistics.com/legal/license/igultimate-eula
GOVERNS THE LICENSING, INSTALLATION AND USE OF INFRAGISTICS SOFTWARE. BY DOWNLOADING AND/OR INSTALLING AND USING INFRAGISTICS SOFTWARE:  you are indicating that you have read and understand this Agreement, and agree to be legally bound by it on behalf of the yourself and your company.
*/
import { BaseDataSource } from "./BaseDataSource";
import { IPageCandidatesSink_$type } from "./IPageCandidatesSink";
import { PagePredictionEngine } from "./PagePredictionEngine";
import { LRUCache$2 } from "./LRUCache$2";
import { Base, runOn, Array_$type, Number_$type, typeCast, fromEnum, typeGetValue, String_$type, Boolean_$type, markType } from "./type";
import { IDataSourcePage_$type } from "./IDataSourcePage";
import { Dictionary$2 } from "./Dictionary$2";
import { SectionMap } from "./SectionMap";
import { DataSourceExecutionContext } from "./DataSourceExecutionContext";
import { SectionData } from "./SectionData";
import { List$1 } from "./List$1";
import { DataSourceSpecialRow } from "./DataSourceSpecialRow";
import { DataSourcePropertiesComparer } from "./DataSourcePropertiesComparer";
import { TransactionState } from "./TransactionState";
import { TransactionType } from "./TransactionType";
import { DataSourceBatchStartedEventArgs } from "./DataSourceBatchStartedEventArgs";
import { DataSourceBatchCompletedEventArgs } from "./DataSourceBatchCompletedEventArgs";
import { truncate, intDivide } from "./number";
/**
 * @hidden
 */
export let VirtualDataSource = /*@__PURE__*/ (() => {
    class VirtualDataSource extends BaseDataSource {
        constructor() {
            super();
            this.cz = null;
            this.di = false;
            this.d5 = 0;
            this.dc = null;
            this.c3 = null;
            this.c2 = null;
            this.d4 = 50;
            this.d3 = 200;
            this.actualPageSizePopulated = false;
            this.dp = 50;
            this.dg = false;
            this.c7 = null;
            this.cx = null;
            this.cy = null;
            this.df = new LRUCache$2(Base.$, IDataSourcePage_$type, 0, 200);
            this.dm = new Dictionary$2(Base.$, Array_$type, 0);
            this.dn = new Dictionary$2(Number_$type, Number_$type, 0);
            this.dh = false;
            this.cv = null;
            this.c0 = null;
            this.de = new SectionMap();
            this.cw = null;
            this.dx = -1;
            this.dq = -1;
            this.dz = -1;
            this.ds = -1;
            this.d0 = -1;
            this.dt = -1;
            this.dy = -1;
            this.dr = -1;
            this.d2 = -1;
            this.d1 = -1;
            this.dv = -1;
            this.du = -1;
            this.dw = -1;
            this.dl = new Dictionary$2(String_$type, Boolean_$type, 0);
            this._concurrencyTag = null;
            this.batchStarted = null;
            this.batchCompleted = null;
            this.dc = new PagePredictionEngine();
            this.dc.e = this;
            this.dc.ag = this.actualPageSize;
            this.dc.f = this.de;
            this.executionContext = new DataSourceExecutionContext();
            this.dc.b = this.executionContext;
            this.isReadOnly = true;
        }
        get_isSectionCollapsable() {
            if (!this.isSectionContentVisible) {
                return true;
            }
            return super.get_isSectionCollapsable();
        }
        set_isSectionCollapsable(a) {
            super.set_isSectionCollapsable(a);
        }
        get_isSectionExpandedDefault() {
            if (!this.isSectionContentVisible) {
                return false;
            }
            if (this.isSectionCollapsable) {
                return super.get_isSectionExpandedDefault();
            }
            return true;
        }
        set_isSectionExpandedDefault(a) {
            super.set_isSectionExpandedDefault(a);
        }
        get_actualBaseDataProvider() {
            return this.actualDataProvider;
        }
        get actualBaseDataProvider() {
            return this.get_actualBaseDataProvider();
        }
        get dataProvider() {
            return this.c3;
        }
        set dataProvider(a) {
            let b = this.c3;
            this.c3 = a;
            if (b != this.c3) {
                this.onPropertyUpdated("DataProvider", b, this.c3);
            }
        }
        get actualDataProvider() {
            if (this.c2 == null) {
                this.actualDataProvider = this.resolveDataProvider();
            }
            return this.c2;
        }
        set actualDataProvider(a) {
            let b = this.c2;
            this.c2 = a;
            if (b != this.c2) {
                this.onPropertyUpdated("ActualDataProvider", b, this.c2);
            }
        }
        get pageSizeRequested() {
            return this.d4;
        }
        set pageSizeRequested(a) {
            let b = this.d4;
            this.d4 = a;
            if (b != this.d4) {
                this.onPropertyUpdated("PageSizeRequested", b, this.d4);
            }
        }
        resetCache() {
            if (this.c8 != null) {
                this.c8.resetCache();
            }
            this.resetCacheOverride();
        }
        resetCacheOverride() {
            this.df.i();
        }
        get maxCachedPages() {
            return this.d3;
        }
        set maxCachedPages(a) {
            let b = this.d3;
            this.d3 = a;
            if (b != this.d3) {
                this.onPropertyUpdated("MaxCachedPages", b, this.d3);
            }
        }
        get actualPageSize() {
            return this.dp;
        }
        set actualPageSize(a) {
            let b = this.dp;
            this.dp = a;
            if (b != this.dp) {
                this.onPropertyUpdated("ActualPageSize", b, this.dp);
            }
        }
        get_isSortingSupported() {
            if (this.externalDataSource != null && !this.dg) {
                this.dg = true;
                let a = this.externalDataSource.isSortingSupportedOverride;
                this.dg = false;
                return a;
            }
            return false;
        }
        get_isFilteringSupported() {
            if (this.externalDataSource != null && !this.dg) {
                this.dg = true;
                let a = this.externalDataSource.isFilteringSupportedOverride;
                this.dg = false;
                return a;
            }
            return false;
        }
        get_isGroupingSupported() {
            if (this.externalDataSource != null && !this.dg) {
                this.dg = true;
                let a = this.externalDataSource.isGroupingSupportedOverride;
                this.dg = false;
                return a;
            }
            return false;
        }
        get c8() {
            return this.c7;
        }
        set c8(a) {
            this.c7 = a;
            this.actualDataProvider = this.resolveDataProvider();
        }
        resolveDataProvider() {
            if (this.c8 == null) {
                return null;
            }
            return this.c8.resolveDataProvider();
        }
        propertyUpdatedOverride(a, b, c) {
            super.propertyUpdatedOverride(a, b, c);
            switch (a) {
                case "DataProvider":
                    this.actualDataProvider = this.dataProvider;
                    this.queueAutoRefresh();
                    break;
                case "ExecutionContext":
                    this.dc.b = this.executionContext;
                    break;
                case "ActualDataProvider":
                    this.actualDataProvider.pageSizeRequested = this.pageSizeRequested;
                    this.actualDataProvider.pageLoaded = runOn(this, this.eq);
                    this.actualDataProvider.batchCompleted = runOn(this, this.ep);
                    this.queueAutoRefresh();
                    break;
                case "PageSizeRequested":
                    this.actualPageSize = this.pageSizeRequested;
                    if (this.actualDataProvider != null) {
                        this.actualDataProvider.pageSizeRequested = this.pageSizeRequested;
                    }
                    this.queueAutoRefresh();
                    break;
                case "ActualPageSize":
                    this.dc.ag = this.actualPageSize;
                    this.queueAutoRefresh();
                    break;
                case "FirstVisibleIndexRequested":
                    this.dc.aa = this.firstVisibleIndexRequested;
                    break;
                case "LastVisibleIndexRequested":
                    this.dc.ae = this.lastVisibleIndexRequested;
                    break;
                case "ActualCount":
                    if (this.actualDataProvider != null && !this.de.q) {
                        this.dc.ab = this.actualDataProvider.actualCount;
                    }
                    else {
                        this.dc.ab = this.actualCount;
                    }
                    this.queueAutoRefresh();
                    break;
                case "MaxCachedPages":
                    this.df.h = this.maxCachedPages;
                    break;
            }
        }
        d9(a) {
            if (this.ap && this.de.q) {
                let b = this.dd(a);
                if (b == null) {
                    b = this.de.d();
                }
                return a - b.t;
            }
            return a;
        }
        eq(a, b, c) {
            let d = this.executionContext;
            if (d != null) {
                d.execute(() => this.ew(a, b, c));
            }
            else {
                this.ew(a, b, c);
            }
        }
        ew(a, b, c) {
            if (a == null) {
                b = this.resolveFullCount(b);
                if (this.actualCount != b) {
                    this.actualCount = b;
                }
                return;
            }
            if (c != this.actualPageSize && !this.actualPageSizePopulated) {
                this.actualPageSize = c;
            }
            this.actualPageSizePopulated = true;
            let d = a.pageIndex();
            this.er(d);
            this.df.item(d, a);
            let e = a.schema();
            if (e != null) {
                this.actualSchema = e;
            }
            let f = a.getSummaryInformation();
            if (this.summaryDescriptions.k.count > 0 && this.c0 == null && f != null) {
                this.c0 = f;
                for (let g = 0; g < this.c0.length; g++) {
                    this.c0[g].summaryIndex = this.d7(this.c0[g]);
                }
                let h = SectionData.r(this.c0);
                this.d5 = h.count;
            }
            let i = a.getGroupInformation();
            if (this.groupDescriptions.k.count > 0 && this.cv == null && i != null) {
                this.cv = i;
                this.ev();
                this.di = false;
            }
            b = this.resolveFullCount(b);
            if (this.actualCount != b) {
                this.actualCount = b;
            }
            this.eu(a);
        }
        d7(a) {
            for (let b = 0; b < this.summaryDescriptions.k.count; b++) {
                let c = this.summaryDescriptions.k.item(b);
                if (c.propertyName == a.propertyName && c.operand == a.operand) {
                    return b;
                }
            }
            return -1;
        }
        resolveFullCount(a) {
            if (this.cv != null) {
                return this.de.u + this.getRootSummaryRowCount();
            }
            return a + this.getRootSummaryRowCount();
        }
        ev() {
            let a = 0;
            let b = 0;
            let c = this.shouldEmitSectionHeaders;
            let d = this.shouldEmitSectionFooters;
            for (let e = 0; e < this.cv.length; e++) {
                let f = new SectionData();
                let g = b;
                let h = this.cv[e].endIndex - this.cv[e].startIndex;
                f.af = a;
                f.ae = e;
                f.d = new Array(this.groupDescriptions.k.count);
                for (let i = 0; i < this.groupDescriptions.k.count; i++) {
                    f.d[i] = 0;
                }
                f.ad = a + h;
                f.t = 0;
                f.e = this.cv[e].groupKeyProperties;
                f.f = this.cv[e].groupKeyValues;
                f.h = new Array(0);
                f.ai(this.sectionHeaderDisplayMode, this.isSectionExpandedDefault);
                this.eo(f, e == 0);
                if (d) {
                    f.u = f.c.length;
                }
                let j = 0;
                f.i = new Array(this.groupDescriptions.k.count);
                if (this.summaryScope == 0 || this.summaryScope == 2) {
                    if (this.cv[e].summaryResults != null) {
                        f.i[this.groupDescriptions.k.count - 1] = this.cv[e].summaryResults;
                        if (f.i != null) {
                            for (let k = 0; k < f.i[this.groupDescriptions.k.count - 1].length; k++) {
                                let l = f.i[this.groupDescriptions.k.count - 1][k];
                                l.summaryIndex = this.d7(l);
                                l.groupKey = f.f;
                            }
                            j = SectionData.r(f.i[this.groupDescriptions.k.count - 1]).count;
                        }
                    }
                }
                if (this.includeSummaryRowsInSection && this.shouldEmitSummaryRows) {
                    if (this.isSectionSummaryRowsAtBottom) {
                        f.ag = j;
                    }
                    else {
                        f.ah = j;
                        g += j;
                    }
                    b += j;
                    f.ad += j;
                }
                if (d) {
                    b++;
                }
                if (c) {
                    let m = 0;
                    f.b = new Array(f.c.length);
                    if (f.z > -1) {
                        let n = this.de.t._inner[f.z];
                        for (let o = 0; o < n.f.length; o++) {
                            m = o;
                            if (!Base.equalsStatic(n.f[o], f.f[o])) {
                                break;
                            }
                        }
                    }
                    for (let p = m; p < f.c.length; p++) {
                        b++;
                        g++;
                        f.ad++;
                        let q = this.ei(f, p);
                        f.a[p] = q;
                        f.b[p] = p - m;
                        if (this.dl.containsKey(q)) {
                            f.c[p] = this.dl.item(q);
                        }
                        else {
                            f.c[p] = this.isSectionExpandedDefault;
                        }
                        if (!f.c[p]) {
                            let r = 0;
                            let s = f.c.length - 1 - p;
                            f.ad -= r;
                            b -= r;
                            if (d) {
                                b--;
                                f.u--;
                            }
                            p += s;
                        }
                    }
                }
                f.y = c ? f.v() : 0;
                f.t = g;
                this.de.z(f, h + 1);
                if (!f.p) {
                    let t = f.w();
                    f.ad -= f.d[t] + j;
                    b -= f.d[t] + j;
                }
                a = f.ad + 1;
                this.de.t.add(f);
                f.q = this.de.r(f);
            }
            let u = 0;
            for (let v = 0; v < this.de.t.count; v++) {
                let w = this.de.t._inner[v];
                if (this.shouldEmitSectionHeaders) {
                    if (!w.q) {
                        let x = w.ad - w.af + 1;
                        this.de.ae(w.ae);
                        this.de.ab(w, -x, -x);
                        v--;
                        u++;
                        continue;
                    }
                }
                if (w.z > -1) {
                    w.z -= u;
                }
            }
        }
        eo(a, b) {
            if (b) {
                this.cx = new Array(this.groupDescriptions.k.count);
                for (let c = 0; c < this.cx.length; c++) {
                    this.cx[c] = a;
                }
            }
            if (this.sectionHeaderDisplayMode == 1) {
                let d = false;
                let e = a.e.length;
                for (let f = 0; f < e; f++) {
                    if (d) {
                        this.cx[f] = a;
                        continue;
                    }
                    let g = false;
                    if (this.cx[f].f[f] == null) {
                        g = a.f[f] != null;
                    }
                    else {
                        g = !Base.equalsStatic(this.cx[f].f[f], a.f[f]);
                    }
                    if (g) {
                        this.cx[f] = a;
                        if (f - 1 > -1) {
                            let h = f - 1;
                            while (h >= 0 && this.cx[h].o) {
                                h = h - 1;
                            }
                            a.z = this.cx[h].ae;
                        }
                        d = true;
                    }
                }
            }
            else {
                let i = false;
                for (let j = 0; j < a.e.length; j++) {
                    if (this.cx[0].f[j] == null) {
                        if (this.cx[0].f[j] != a.f[j]) {
                            i = true;
                            break;
                        }
                        continue;
                    }
                    if (!Base.equalsStatic(this.cx[0].f[j], a.f[j])) {
                        i = true;
                        break;
                    }
                }
                if (i) {
                    this.cx[0] = a;
                }
            }
        }
        en(a) {
        }
        eu(a) {
            if (this.updateNotifier != null) {
                let b = a.pageIndex() * this.actualPageSize;
                if (this.actualDataProvider != null) {
                    if (b > this.actualDataProvider.actualCount) {
                        return;
                    }
                }
                let c = this.d8(b);
                let d = this.d8(b + a.count() - 1);
                if (c > 0 && this.getRowType(c - 1) == 1) {
                    c--;
                }
                if (this.actualCount == 0 && a.count() == 0) {
                    this.onClearItems();
                }
                else {
                    this.updateNotifier.rangeActualized(c, d);
                }
            }
        }
        d8(a) {
            if (this.ap && this.de.q) {
                let b = this.de.g(a);
                if (b == null) {
                    b = this.de.d();
                }
                if (!b.p) {
                    return b.af;
                }
                return a + b.t;
            }
            return a;
        }
        es(a) {
            a();
        }
        get_isVirtual() {
            return true;
        }
        isPlaceholderItem(a) {
            let b = this.c1(a);
            let c = b[0];
            if (!this.df.d(c)) {
                if (b[1] == -1) {
                    return false;
                }
                return true;
            }
            return false;
        }
        getItemAtIndex(a) {
            if (a >= this.actualCount - this.getRootSummaryRowCount()) {
                return this.ed(a);
            }
            let b = this.c1(a);
            let c = b[0];
            if (!this.df.d(c)) {
                if (b[1] == -1) {
                    return this.ed(a);
                }
                return null;
            }
            let d = this.df.item(c);
            let e = b[1];
            if (e == -1) {
                return this.ed(a);
            }
            return d.getItemAtIndex(e);
        }
        getItemFromKey(a) {
            let b = this.indexOfKey(a);
            if (b >= 0) {
                return this.getItemAtIndex(b);
            }
            return null;
        }
        ed(a) {
            if (a >= this.actualCount - this.getRootSummaryRowCount()) {
                let b = new DataSourceSpecialRow();
                b.rowType = 4;
                b.level = 0;
                let c = a - (this.actualCount - this.getRootSummaryRowCount());
                let d = SectionData.r(this.c0);
                let e = new Array(d._inner[c].count);
                d._inner[c].values.copyTo(e, 0);
                b.summaryResults = e;
                return b;
            }
            let f = this.dd(a);
            if (f != null) {
                let g = f.j(a);
                if (g == 1 || g == 2) {
                    let h = new DataSourceSpecialRow();
                    h.rowType = g;
                    h.summaryResults = f.i[f.i.length - 1];
                    h.level = g == 1 ? f.w() + (a - f.af) : (f.u - 1) - (f.w() + (a - (f.ad - f.u + 1)));
                    if (this.sectionHeaderDisplayMode == 0) {
                        for (let i = 0; i < this.groupDescriptions.k.count; i++) {
                            h.setSectionValue(this.groupDescriptions.k.item(i).propertyName, f.f[i]);
                            h.setValue(this.groupDescriptions.k.item(i).propertyName, f.f[i]);
                        }
                    }
                    else {
                        if (h.level >= 0 && h.level < this.groupDescriptions.k.count) {
                            h.setSectionValue(this.groupDescriptions.k.item(h.level).propertyName, f.f[h.level]);
                            h.setValue(this.groupDescriptions.k.item(h.level).propertyName, f.f[h.level]);
                        }
                    }
                    return h;
                }
                else if (g == 5) {
                    let j = new DataSourceSpecialRow();
                    j.rowType = 5;
                    j.level = f.c.length;
                    let k = f.x(a);
                    let l = SectionData.r(f.i[f.i.length - 1]);
                    let m = new Array(l._inner[k].count);
                    l._inner[k].values.copyTo(m, 0);
                    j.summaryResults = m;
                    return j;
                }
            }
            return null;
        }
        c1(a) {
            if (this.ap && this.de.q) {
                let b = false;
                let c = this.dd(a);
                if (c == null) {
                    c = this.de.d();
                    if (this.c0.length > 0 && a > c.ad) {
                        b = true;
                    }
                }
                let d = c.af;
                if (this.shouldEmitSectionHeaders && a >= d && a < d + c.v()) {
                    b = true;
                }
                if (a - (d + c.v() - 1) <= c.aa + c.ah) {
                    b = true;
                }
                if (this.shouldEmitSectionFooters) {
                    if (a <= c.ad && a >= c.ad - c.c.length - c.ag) {
                        b = true;
                    }
                }
                else if (c.ag > 0) {
                    if (a > c.ad - c.ag && a <= c.ad) {
                        b = true;
                    }
                }
                let e = a - c.t;
                let f = truncate(Math.floor(e / this.actualPageSize));
                let g = e % this.actualPageSize;
                if (b) {
                    g = -1;
                }
                let h = new Array(2);
                h[0] = f;
                h[1] = g;
                return h;
            }
            else {
                let i = truncate(Math.floor(a / this.actualPageSize));
                let j = a % this.actualPageSize;
                let k = new Array(2);
                k[0] = i;
                k[1] = j;
                return k;
            }
        }
        dd(a) {
            return this.de.e(a);
        }
        getItemPropertyAtIndex(a, b) {
            if (a > (this.actualCount - 1) - this.getRootSummaryRowCount()) {
                return this.ee(a, b);
            }
            let c = this.c1(a);
            let d = c[0];
            if (!this.df.d(d)) {
                if (c[1] == -1) {
                    return this.ee(a, b);
                }
                return null;
            }
            let e = this.df.item(d);
            let f = c[1];
            if (f == -1) {
                return this.ee(a, b);
            }
            if (this.aq()) {
                let g = e.getItemAtIndex(f);
                let h = this.an(g, b);
                if (h) {
                    let i = this.a1(g, b);
                    return i;
                }
            }
            return e.getItemValueAtIndex(f, b);
        }
        ee(a, b) {
            let c = this.ed(a);
            if (typeCast(DataSourceSpecialRow.$, c) !== null) {
                return c.getValue(b);
            }
            return null;
        }
        et(a) {
            if (!this.dn.containsKey(a)) {
                this.dn.addItem(a, 1);
            }
            else {
                this.dn.item(a, this.dn.item(a) + 1);
            }
        }
        er(a) {
            if (this.dn.containsKey(a)) {
                this.dn.item(a, this.dn.item(a) - 1);
                if (this.dn.item(a) <= 0) {
                    this.dn.removeItem(a);
                    if (this.actualDataProvider != null) {
                        this.actualDataProvider.removePageRequest(a);
                    }
                }
            }
        }
        addCandidate(a, b) {
            let c = false;
            if (!this.dm.containsKey(a)) {
                let d = new List$1(Number_$type, 0);
                let e = this.transformPage(a);
                for (let f = 0; f < e.length; f++) {
                    let g = e[f];
                    if (!this.df.d(g)) {
                        d.add(g);
                        this.et(g);
                        let h = this.dn.item(g);
                        if (h == 1 && this.actualDataProvider != null) {
                            this.actualDataProvider.addPageRequest(g, b);
                        }
                        c = true;
                    }
                }
                if (d.count > 0) {
                    this.dm.addItem(a, d.toArray());
                }
            }
            return c;
        }
        removeCandidate(a) {
            if (this.dm.containsKey(a)) {
                for (let b = 0; b < this.dm.item(a).length; b++) {
                    let c = this.dm.item(a)[b];
                    this.er(c);
                }
                this.dm.removeItem(a);
            }
        }
        transformPage(a) {
            let b = [a];
            if (this.ap && this.de.q) {
                let c = a * this.actualPageSize;
                let d = c + this.actualPageSize - 1;
                let e = this.dd(c);
                let f = new List$1(Number_$type, 0);
                for (let g = c; g <= d; g++) {
                    if (e == null) {
                        break;
                    }
                    if (g > e.ad) {
                        if (e.ae < this.de.t.count - 1) {
                            e = this.de.t._inner[e.ae + 1];
                        }
                        else {
                            break;
                        }
                    }
                    if (!e.p || (g >= e.af && g <= e.af + (e.v() - 1) + e.aa)) {
                        continue;
                    }
                    let h = g - e.t;
                    let i = intDivide(h, this.actualPageSize);
                    if (!f.contains(i)) {
                        f.add(i);
                    }
                }
                b = f.toArray();
            }
            return b;
        }
        getUnrealizedCount() {
            let a = this.df.g * this.actualPageSize;
            let b = this.actualCount - a;
            return b;
        }
        onSetItemOverride(a, b, c) {
            super.onSetItemOverride(a, b, c);
            let d = this.c1(a);
            let e = d[0];
            if (this.df.d(e)) {
                this.df.j(e);
            }
        }
        refreshInternalOverride() {
            super.refreshInternalOverride();
            this.actualPageSizePopulated = false;
            let a = this.actualCount != 0;
            this.dh = true;
            if (!this.di) {
                this.resetCache();
                if (a) {
                    this.onClearItems();
                }
                this.cv = null;
                this.c0 = null;
                this.d5 = 0;
                this.de.v();
            }
            else {
                this.di = false;
                if (a) {
                    this.onClearItems();
                }
            }
            this.ex();
            this.dc.au();
            this.dh = false;
        }
        ex() {
            if (this.actualDataProvider != null) {
                for (let a of fromEnum(this.dm.values)) {
                    for (let c = 0; c < a.length; c++) {
                        let b = a[c];
                        this.actualDataProvider.addPageRequest(b, 1);
                    }
                }
            }
        }
        onClearItemsOverride() {
            super.onClearItemsOverride();
            if (!this.dh) {
                this.queueAutoRefresh();
            }
        }
        onInsertItemOverride(a, b) {
            super.onInsertItemOverride(a, b);
            this.queueAutoRefresh();
        }
        onRemoveItemOverride(a, b) {
            super.onRemoveItemOverride(a, b);
            this.queueAutoRefresh();
        }
        get_isItemIndexLookupSupported() {
            return true;
        }
        get_isKeyIndexLookupSupported() {
            return true;
        }
        indexOfItem(a) {
            let b = this.df.b;
            let c = b.o;
            let d = b.q;
            let e = d.count;
            let f = b.p;
            for (let g = 0; g < e; g++) {
                if (f._inner[g]) {
                    continue;
                }
                let h = d._inner[g].b;
                let i = h.count();
                for (let j = 0; j < i; j++) {
                    if (this.dk(h.getItemAtIndex(j), a)) {
                        let k = typeGetValue(c._inner[g]);
                        let l = k * this.actualPageSize;
                        return l + j;
                    }
                }
            }
            if (this.actualDataProvider != null && this.actualDataProvider.isItemIndexLookupSupported) {
                return this.actualDataProvider.indexOfItem(a);
            }
            return -1;
        }
        dk(a, b) {
            if (a == null && b == null) {
                return true;
            }
            if (a == null || b == null) {
                return false;
            }
            return Base.equalsStatic(a, b);
        }
        indexOfKey(a) {
            let b = this.actualPrimaryKey;
            if (b == null || b.length < 1 || this.actualBaseDataProvider == null) {
                return -1;
            }
            this.ensureComparables(this.actualSchema);
            let c = this.db();
            if (this.ap && this.shouldEmitSectionHeaders && !this.isSectionContentVisible && this.isSectionHeaderNormalRow) {
                if (this.de.t.count > 0) {
                    for (let d = 0; d < this.de.t.count; d++) {
                        let e = this.de.t._inner[d];
                        let f = new DataSourceSpecialRow();
                        for (let g = 0; g < e.e.length; g++) {
                            let h = e.e[g];
                            let i = e.f[g];
                            f.setSectionValue(h, i);
                        }
                        if (c.i(f, a) == 0) {
                            return d;
                        }
                    }
                }
            }
            let j = this.df.b;
            let k = j.o;
            let l = j.q;
            let m = l.count;
            let n = j.p;
            for (let o = 0; o < m; o++) {
                if (n._inner[o]) {
                    continue;
                }
                let p = l._inner[o].b;
                let q = p.count();
                for (let r = 0; r < q; r++) {
                    if (c.i(p.getItemAtIndex(r), a) == 0) {
                        let s = typeGetValue(k._inner[o]);
                        let t = s * this.actualPageSize;
                        return t + r;
                    }
                }
            }
            if (this.actualDataProvider != null && this.actualDataProvider.isKeyIndexLookupSupported) {
                return this.actualDataProvider.indexOfKey(a);
            }
            return -1;
        }
        db() {
            let a = new Array(this.actualPrimaryKey.length);
            for (let b = 0; b < a.length; b++) {
                a[b] = 0;
            }
            return new DataSourcePropertiesComparer(this.actualPrimaryKey, a, this.cz, this);
        }
        getStickyRowPriority(a) {
            let b = this.getRowType(a);
            switch (b) {
                case 1: return 100 - this.getRowLevel(a);
                case 2: return 99 - this.getRowLevel(a);
                case 3:
                case 5: return 2;
                case 4: return 3;
            }
            return 1;
        }
        unpinRow(a) {
            super.unpinRow(a);
        }
        pinRow(a) {
            super.pinRow(a);
        }
        isRowPinned(a) {
            return super.isRowPinned(a);
        }
        getStickyRowsInRange(a, b) {
            if ((this.groupDescriptions == null || this.groupDescriptions.k.count == 0) && (this.summaryDescriptions == null || this.summaryDescriptions.k.count == 0)) {
                return null;
            }
            let c = this.dd(a);
            let d = this.dd(b);
            if (this.de.t.count > 0) {
                if (this.de.t.count == 1) {
                    c = this.de.t._inner[0];
                    d = this.de.t._inner[0];
                }
                else {
                    c = this.de.e(a);
                    if (c != null) {
                        while (c.z != -1) {
                            c = this.de.t._inner[c.z];
                        }
                    }
                    d = this.de.e(b);
                    if (b >= this.actualCount - this.getRootSummaryRowCount()) {
                        d = this.de.d();
                    }
                }
            }
            else if (this.getRootSummaryRowCount() > 0) {
                let e = new List$1(Number_$type, 0);
                for (let f = this.actualCount - this.getRootSummaryRowCount(); f < this.actualCount; f++) {
                    e.add(f);
                }
                return e.toArray();
            }
            if (c == null || d == null) {
                return null;
            }
            if (c.ae == this.dx && c.aa == this.dz && c.af == this.d0 && c.ad == this.dy && c.ah == this.d2 && c.ag == this.d1 && d.ae == this.dq && d.aa == this.ds && d.af == this.dt && d.ad == this.dr && d.ah == this.dv && d.ag == this.du && this.getRootSummaryRowCount() == this.dw) {
                return this.cw;
            }
            this.dx = c.ae;
            this.dq = d.ae;
            this.dz = c.aa;
            this.ds = d.aa;
            this.d0 = c.af;
            this.dt = d.af;
            this.dy = c.ad;
            this.dr = d.ad;
            this.dv = d.ah;
            this.du = d.ag;
            this.d2 = c.ah;
            this.d1 = c.ag;
            this.dw = this.getRootSummaryRowCount();
            let g = new List$1(Number_$type, 0);
            for (let h = c.ae; h <= d.ae; h++) {
                let i = this.de.t._inner[h];
                let j = i.c.length;
                let k = i.v();
                if (this.shouldEmitSectionHeaders && this.ap) {
                    for (let l = 0; l < i.c.length; l++) {
                        if (i.a[l] != null) {
                            let m = i.af + i.b[l];
                            g.add(m);
                        }
                        if (!i.c[l]) {
                            break;
                        }
                    }
                }
                if (i.p) {
                    for (let n = 0; n < i.ah; n++) {
                        g.add(i.af + n + k);
                    }
                    if (this.shouldEmitShiftedRows) {
                        for (let o = 0; o < i.aa; o++) {
                            g.add(i.af + o + j);
                        }
                    }
                    if (this.summaryScope == 0 || this.summaryScope == 2) {
                        if (this.includeSummaryRowsInSection && this.isSectionSummaryRowsAtBottom) {
                            for (let p = i.ag - 1; p >= 0; p--) {
                                if (this.shouldEmitSectionFooters) {
                                    g.add(i.ad - k - p);
                                }
                                else {
                                    g.add(i.ad - p);
                                }
                            }
                        }
                    }
                }
                if (this.shouldEmitSectionFooters && this.ap) {
                    for (let q = i.c.length - 1; q >= 0; q--) {
                        if (!i.c[q]) {
                            break;
                        }
                        g.add(i.ad - q);
                    }
                }
            }
            for (let r = this.actualCount - this.getRootSummaryRowCount(); r < this.actualCount; r++) {
                g.add(r);
            }
            this.cw = g.toArray();
            return this.cw;
        }
        isExclusivelySticky(a) {
            let b = this.getRowType(a);
            return b == 1 || b == 2 || b == 4 || (this.isSectionSummaryRowsAtBottom && b == 5);
        }
        getRowType(a) {
            if (a < 0) {
                return 0;
            }
            let b = this.getItemAtIndex(a);
            let item_ = b;
            if ((item_ != null && item_.$$isSpecialRow !== undefined)) {
                let c = b.rowType;
                if (this.isSectionHeaderNormalRow && c == 1) {
                    return 0;
                }
                return c;
            }
            return 0;
        }
        getIsRowExpandedAtIndex(a) {
            let b = this.de.e(a);
            if (b == null) {
                b = this.de.d();
            }
            for (let c = 0; c < b.a.length; c++) {
                if (b.a[c] != null) {
                    if (a == b.af + b.b[c]) {
                        return b.c[c];
                    }
                }
            }
            return super.getIsRowExpandedAtIndex(a);
        }
        setIsRowExpandedAtIndex(a, b) {
            let c = this.de.e(a);
            if (c == null) {
                c = this.de.d();
            }
            for (let d = 0; d < c.a.length; d++) {
                if (c.a[d] != null) {
                    if (a == c.af + c.b[d]) {
                        let e = false;
                        let f = c.a[d];
                        if (this.dl.containsKey(f) && this.dl.item(f) != b) {
                            let g = this.dl.item(f);
                            if (b == this.isSectionExpandedDefault) {
                                this.dl.removeItem(f);
                            }
                            else {
                                this.dl.item(f, b);
                            }
                            e = true;
                            this.onRowExpansionChanged(a, g, b);
                        }
                        else if (b != this.isSectionExpandedDefault) {
                            this.dl.addItem(f, b);
                            e = true;
                            this.onRowExpansionChanged(a, this.isSectionExpandedDefault, b);
                        }
                        if (e) {
                            this.de.v();
                            this.ev();
                            this.di = true;
                            if (this.actualCount != this.de.u) {
                                this.actualCount = this.de.u + this.getRootSummaryRowCount();
                            }
                            else {
                                this.queueAutoRefresh();
                            }
                        }
                        break;
                    }
                }
            }
        }
        getRowLevel(a) {
            if (a < 0) {
                return 0;
            }
            let b = this.getItemAtIndex(a);
            let item_ = b;
            if ((item_ != null && item_.$$isSpecialRow !== undefined)) {
                return b.level;
            }
            if (this.isGroupingSupported) {
                if (this.sectionHeaderDisplayMode == 1) {
                    return this.groupDescriptions.k.count;
                }
                else if (this.groupDescriptions.k.count > 0) {
                    return 1;
                }
            }
            return 0;
        }
        getRootSummaryRowCount() {
            return this.shouldEmitSummaryRows ? this.d5 : 0;
        }
        eh(a) {
            let b = "";
            for (let c = 0; c < a.e.length; c++) {
                b += a.e[c] + ":" + a.f[c];
            }
            return b;
        }
        ei(a, b) {
            if (this.sectionHeaderDisplayMode == 0) {
                return this.eh(a);
            }
            let c = "";
            for (let d = 0; d < a.e.length; d++) {
                c += a.e[d] + ":" + a.f[d] + ":";
            }
            c += b;
            return c;
        }
        getRootSummaryResults() {
            return this.c0;
        }
        getSectionSummaryResults(a) {
            if (this.de.t.count > 0 && a >= 0 && a < this.de.t.count) {
                return this.de.t._inner[a].i;
            }
            return null;
        }
        clone() {
            return null;
        }
        cloneProperties(a) {
            super.cloneProperties(a);
            let b = typeCast(VirtualDataSource.$, a);
            if (b != null) {
                b.pageSizeRequested = this.pageSizeRequested;
                b.maxCachedPages = this.maxCachedPages;
            }
        }
        get concurrencyTag() {
            return this._concurrencyTag;
        }
        set concurrencyTag(a) {
            this._concurrencyTag = a;
        }
        get_isBatchingEnabled() {
            return true;
        }
        set_isBatchingEnabled(a) {
            super.set_isBatchingEnabled(a);
        }
        updatePropertyAtKey(a, b, c, d = false) {
            let e = super.updatePropertyAtKey(a, b, c, d);
            if (this.concurrencyTag != null && this.aq()) {
                let f = this.indexOfKey(a);
                if (f > -1) {
                    let g = this.getItemAtIndex(f);
                    let h = this.actualDataProvider.getItemValue(g, this.concurrencyTag);
                    if (h != null) {
                        let i = this.u.g(a);
                        i.version = h;
                    }
                }
            }
            return e;
        }
        removeItemByKey(a) {
            super.removeItemByKey(a);
            if (this.concurrencyTag != null && this.aq()) {
                let b = this.indexOfKey(a);
                if (b > -1) {
                    let c = this.getItemAtIndex(b);
                    let d = this.actualDataProvider.getItemValue(c, this.concurrencyTag);
                    if (d != null) {
                        let e = this.u.g(a);
                        e.version = d;
                    }
                }
            }
        }
        co(a, b) {
            if (a == 5) {
                let c = b;
                let d = c.a;
                let e = new List$1(TransactionState.$, 0);
                for (let f = 0; f < d.length; f++) {
                    let g = d[f].transactionType;
                    let h = null;
                    let i = null;
                    if (g == TransactionType.Delete || g == 1) {
                        let j = new Dictionary$2(String_$type, Base.$, 0);
                        let k = d[f].id;
                        for (let l = 0; l < this.actualPrimaryKey.length; l++) {
                            j.addItem(this.actualPrimaryKey[l], k[l]);
                        }
                        h = j;
                    }
                    if (g == 0) {
                        let m = new Dictionary$2(String_$type, Base.$, 0);
                        let n = d[f].id[0];
                        for (let o = 0; o < this.actualSchema.propertyNames.length; o++) {
                            let p = this.actualSchema.propertyNames[o];
                            m.addItem(p, this.actualDataProvider.getItemValue(n, p));
                        }
                        i = m;
                    }
                    else if (g == 1) {
                        i = d[f].value;
                    }
                    if (h != null) {
                        let q = {};
                        let r = h;
                        for (let s of fromEnum(r)) {
                            q[s.key] = s.value;
                        }
                        h = q;
                    }
                    if (i != null) {
                        let t = {};
                        let u = i;
                        for (let v of fromEnum(u)) {
                            t[v.key] = v.value;
                        }
                        i = t;
                    }
                    e.add(((() => {
                        let $ret = new TransactionState(h, g, i);
                        $ret.version = d[f].version;
                        return $ret;
                    })()));
                }
                let w = e.toArray();
                if (this.batchStarted != null) {
                    this.batchStarted(this, new DataSourceBatchStartedEventArgs(w));
                }
                this.actualDataProvider.createBatchRequest(w);
            }
        }
        ep(a, b, c) {
            if (b) {
                this.queueAutoRefresh();
            }
            if (this.batchCompleted != null) {
                this.batchCompleted(this, new DataSourceBatchCompletedEventArgs(a, c));
            }
        }
    }
    VirtualDataSource.$t = /*@__PURE__*/ markType(VirtualDataSource, 'VirtualDataSource', BaseDataSource.$, [IPageCandidatesSink_$type]);
    return VirtualDataSource;
})();
